import{t as C,a as A,n as Je,c as ke}from"../chunks/DV0htR0b.js";import{i as Ye}from"../chunks/DvLNuc85.js";import{A as Y,I as ha,H as ma,b as t,d as ie,M as ya,O as He,Q as Fe,R as xe,X as re,am as wa,T as je,U as Ge,V as ba,aq as Ke,ai as ka,m as $,aw as Ne,ax as Te,ac as ge,ay as xa,az as Ta,aA as Ea,ap as Aa,aB as Sa,a5 as Ia,aC as $a,aD as Ca,ak as Ma,J as Da,aE as Ha,aF as Fa,Y as Na,u as Ra,aG as La,aH as za,Z as Oa,o as se,af as Re,ag as Le,ah as Ba,q as Xe,aI as Ae,i as h,a3 as ze,aJ as Ze,x,y as T,w as N,r as P,v as Qe,au as ee,z as Pa,aK as Oe,a6 as Ee}from"../chunks/DCkLJiGP.js";import{b as qa,w as Ua,s as X,e as W}from"../chunks/DeRr3rea.js";import{i as O,b as Be}from"../chunks/Bug4azAl.js";import{s as ae,b as Va,r as Wa}from"../chunks/yRR4lMfm.js";import{a as Ja,o as Ya}from"../chunks/DzGvXcqd.js";import{p as te}from"../chunks/DoXvTXvK.js";import{g as de}from"../chunks/BDDU8JJk.js";function Pe(i,e){return e}function ja(i,e,a,r){for(var o=[],f=e.length,l=0;l<f;l++)Ea(e[l].e,o,!0);var _=f>0&&o.length===0&&a!==null;if(_){var m=a.parentNode;Aa(m),m.append(a),r.clear(),J(i,e[0].prev,e[f-1].next)}Sa(o,()=>{for(var u=0;u<f;u++){var s=e[u];_||(r.delete(s.k),J(i,s.prev,s.next)),Ia(s.e,!_)}})}function qe(i,e,a,r,o,f=null){var l=i,_={flags:e,items:new Map,first:null};Y&&ha();var m=null,u=!1,s=ie(()=>{var y=a();return ka(y)?y:y==null?[]:Ke(y)});ma(()=>{var y=t(s),v=y.length;if(u&&v===0)return;u=v===0;let c=!1;if(Y){var p=l.data===ya;p!==(v===0)&&(l=He(),Fe(l),xe(!1),c=!0)}if(Y){for(var w=null,b,d=0;d<v;d++){if(re.nodeType===8&&re.data===wa){l=re,c=!0,xe(!1);break}var I=y[d],M=r(I,d);b=ea(re,_,w,null,I,M,d,o,e,a),_.items.set(M,b),w=b}v>0&&Fe(He())}Y||Ga(y,_,l,o,e,r,a),f!==null&&(v===0?m?je(m):m=Ge(()=>f(l)):m!==null&&ba(m,()=>{m=null})),c&&xe(!0),t(s)}),Y&&(l=re)}function Ga(i,e,a,r,o,f,l){var _=i.length,m=e.items,u=e.first,s=u,y,v=null,c=[],p=[],w,b,d,I;for(I=0;I<_;I+=1){if(w=i[I],b=f(w,I),d=m.get(b),d===void 0){var M=s?s.e.nodes_start:a;v=ea(M,e,v,v===null?e.first:v.next,w,b,I,r,o,l),m.set(b,v),c=[],p=[],s=v.next;continue}if(Ka(d,w,I),(d.e.f&Te)!==0&&je(d.e),d!==s){if(y!==void 0&&y.has(d)){if(c.length<p.length){var L=p[0],D;v=L.prev;var q=c[0],U=c[c.length-1];for(D=0;D<c.length;D+=1)Ue(c[D],L,a);for(D=0;D<p.length;D+=1)y.delete(p[D]);J(e,q.prev,U.next),J(e,v,q),J(e,U,L),s=L,v=U,I-=1,c=[],p=[]}else y.delete(d),Ue(d,s,a),J(e,d.prev,d.next),J(e,d,v===null?e.first:v.next),J(e,v,d),v=d;continue}for(c=[],p=[];s!==null&&s.k!==b;)(s.e.f&Te)===0&&(y??(y=new Set)).add(s),p.push(s),s=s.next;if(s===null)continue;d=s}c.push(d),v=d,s=d.next}if(s!==null||y!==void 0){for(var z=y===void 0?[]:Ke(y);s!==null;)(s.e.f&Te)===0&&z.push(s),s=s.next;var R=z.length;if(R>0){var ne=null;ja(e,z,ne,m)}}ge.first=e.first&&e.first.e,ge.last=v&&v.e}function Ka(i,e,a,r){Ta(i.v,e),i.i=a}function ea(i,e,a,r,o,f,l,_,m,u){var s=(m&$a)!==0,y=(m&Ca)===0,v=s?y?$(o):Ne(o):o,c=(m&xa)===0?l:Ne(l),p={i:c,v,k:f,a:null,e:null,prev:a,next:r};try{return p.e=Ge(()=>_(i,v,c,u),Y),p.e.prev=a&&a.e,p.e.next=r&&r.e,a===null?e.first=p:(a.next=p,a.e.next=p.e),r!==null&&(r.prev=p,r.e.prev=p.e),p}finally{}}function Ue(i,e,a){for(var r=i.next?i.next.e.nodes_start:a,o=e?e.e.nodes_start:a,f=i.e.nodes_start;f!==r;){var l=Ma(f);o.before(f),f=l}}function J(i,e,a){e===null?i.first=a:(e.next=a,e.e.next=a&&a.e),a!==null&&(a.prev=e,a.e.prev=e&&e.e)}function Xa(i,e,a){var r=i==null?"":""+i;return e&&(r=r?r+" "+e:e),r===""?null:r}function pe(i,e,a,r,o,f){var l=i.__className;if(Y||l!==a||l===void 0){var _=Xa(a,r);(!Y||_!==i.getAttribute("class"))&&(_==null?i.removeAttribute("class"):i.className=_),i.__className=a}return f}const Za=()=>performance.now(),B={tick:i=>requestAnimationFrame(i),now:()=>Za(),tasks:new Set};function aa(){const i=B.now();B.tasks.forEach(e=>{e.c(i)||(B.tasks.delete(e),e.f())}),B.tasks.size!==0&&B.tick(aa)}function Qa(i){let e;return B.tasks.size===0&&B.tick(aa),{promise:new Promise(a=>{B.tasks.add(e={c:i,f:a})}),abort(){B.tasks.delete(e)}}}function ue(i,e){Ua(()=>{i.dispatchEvent(new CustomEvent(e))})}function et(i){if(i==="float")return"cssFloat";if(i==="offset")return"cssOffset";if(i.startsWith("--"))return i;const e=i.split("-");return e.length===1?e[0]:e[0]+e.slice(1).map(a=>a[0].toUpperCase()+a.slice(1)).join("")}function Ve(i){const e={},a=i.split(";");for(const r of a){const[o,f]=r.split(":");if(!o||f===void 0)break;const l=et(o.trim());e[l]=f.trim()}return e}const at=i=>i;function tt(i,e,a,r){var o=(i&La)!==0,f="both",l,_=e.inert,m=e.style.overflow,u,s;function y(){var b=Ba,d=ge;Re(null),Le(null);try{return l??(l=a()(e,(r==null?void 0:r())??{},{direction:f}))}finally{Re(b),Le(d)}}var v={is_global:o,in(){e.inert=_,ue(e,"introstart"),u=Se(e,y(),s,1,()=>{ue(e,"introend"),u==null||u.abort(),u=l=void 0,e.style.overflow=m})},out(b){e.inert=!0,ue(e,"outrostart"),s=Se(e,y(),u,0,()=>{ue(e,"outroend"),b==null||b()})},stop:()=>{u==null||u.abort(),s==null||s.abort()}},c=ge;if((c.transitions??(c.transitions=[])).push(v),qa){var p=o;if(!p){for(var w=c.parent;w&&(w.f&Da)!==0;)for(;(w=w.parent)&&(w.f&Ha)===0;);p=!w||(w.f&Fa)!==0}p&&Na(()=>{Ra(()=>v.in())})}}function Se(i,e,a,r,o){var f=r===1;if(za(e)){var l,_=!1;return Oa(()=>{if(!_){var b=e({direction:f?"in":"out"});l=Se(i,b,a,r,o)}}),{abort:()=>{_=!0,l==null||l.abort()},deactivate:()=>l.deactivate(),reset:()=>l.reset(),t:()=>l.t()}}if(a==null||a.deactivate(),!(e!=null&&e.duration))return o(),{abort:se,deactivate:se,reset:se,t:()=>r};const{delay:m=0,css:u,tick:s,easing:y=at}=e;var v=[];if(f&&a===void 0&&(s&&s(0,1),u)){var c=Ve(u(0,1));v.push(c,c)}var p=()=>1-r,w=i.animate(v,{duration:m});return w.onfinish=()=>{var b=(a==null?void 0:a.t())??1-r;a==null||a.abort();var d=r-b,I=e.duration*Math.abs(d),M=[];if(I>0){var L=!1;if(u)for(var D=Math.ceil(I/16.666666666666668),q=0;q<=D;q+=1){var U=b+d*y(q/D),z=Ve(u(U,1-U));M.push(z),L||(L=z.overflow==="hidden")}L&&(i.style.overflow="hidden"),p=()=>{var R=w.currentTime;return b+d*y(R/I)},s&&Qa(()=>{if(w.playState!=="running")return!1;var R=p();return s(R,1-R),!0})}w=i.animate(M,{duration:I,fill:"forwards"}),w.onfinish=()=>{p=()=>r,s==null||s(r,1-r),o()}},{abort:()=>{w&&(w.cancel(),w.effect=null,w.onfinish=se)},deactivate:()=>{o=se},reset:()=>{r===0&&(s==null||s(1,0))},t:()=>p()}}var rt=C('<div class="dot-flashing svelte-yc7ucn"></div>'),st=C('<div class="message-content svelte-yc7ucn"> </div>'),it=C('<div class="timestamp svelte-yc7ucn"> </div>'),nt=C("<div><div><!></div> <!></div>");function We(i,e){Xe(e,!1);const a=$();let r=te(e,"message",8),o=te(e,"isLoading",8,!1);Ae(()=>(ze(r()),ze(o())),()=>{h(a,{base:"message-bubble",user:r().sender==="user"?"user-message":"",ai:r().sender==="ai"?"ai-message":"",loading:o()?"loading":""})}),Ze(),Ye();var f=nt(),l=x(f),_=x(l);{var m=v=>{var c=rt();A(v,c)},u=v=>{var c=st(),p=x(c,!0);T(c),P(()=>X(p,r().text??r().content)),A(v,c)};O(_,v=>{o()?v(m):v(u,!1)})}T(l);var s=N(l,2);{var y=v=>{var c=it(),p=x(c,!0);T(c),P(w=>X(p,w),[()=>new Date(r().timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})],ie),A(v,c)};O(s,v=>{o()||v(y)})}T(f),P(()=>{pe(f,1,`message-wrapper ${(r().sender==="user"?"user":"ai")??""}`,"svelte-yc7ucn"),pe(l,1,`${t(a).base??""} ${t(a).user??""} ${t(a).ai??""} ${t(a).loading??""}`,"svelte-yc7ucn")}),A(i,f),Qe()}function ot(i){const e=i-1;return e*e*e+1}function lt(i,{delay:e=0,duration:a=400,easing:r=ot,axis:o="y"}={}){const f=getComputedStyle(i),l=+f.opacity,_=o==="y"?"height":"width",m=parseFloat(f[_]),u=o==="y"?["top","bottom"]:["left","right"],s=u.map(d=>`${d[0].toUpperCase()}${d.slice(1)}`),y=parseFloat(f[`padding${s[0]}`]),v=parseFloat(f[`padding${s[1]}`]),c=parseFloat(f[`margin${s[0]}`]),p=parseFloat(f[`margin${s[1]}`]),w=parseFloat(f[`border${s[0]}Width`]),b=parseFloat(f[`border${s[1]}Width`]);return{delay:e,duration:a,easing:r,css:d=>`overflow: hidden;opacity: ${Math.min(d*20,1)*l};${_}: ${d*m}px;padding-${u[0]}: ${d*y}px;padding-${u[1]}: ${d*v}px;margin-${u[0]}: ${d*c}px;margin-${u[1]}: ${d*p}px;border-${u[0]}-width: ${d*w}px;border-${u[1]}-width: ${d*b}px;min-${_}: 0`}}var vt=Je('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.405Z"></path></svg>');function ft(i,e){let a=te(e,"size",8,24),r=te(e,"color",8,"currentColor");var o=vt();P(()=>{ae(o,"fill",r()),ae(o,"width",a()),ae(o,"height",a())}),A(i,o)}var ct=Je('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>');function dt(i,e){let a=te(e,"size",8,24),r=te(e,"color",8,"currentColor");var o=ct();P(()=>{ae(o,"stroke",r()),ae(o,"width",a()),ae(o,"height",a())}),A(i,o)}var ut=C('<div class="sidebar-spinner svelte-gnpoyf"><div class="spinner svelte-gnpoyf"></div></div>'),gt=C('<div><div class="session-info svelte-gnpoyf"><div class="session-name svelte-gnpoyf"> </div> <div class="session-time svelte-gnpoyf"> </div></div> <button class="delete-button svelte-gnpoyf" aria-label="Delete session">삭제</button></div>'),pt=C('<button class="icon-button login-button svelte-gnpoyf">로그아웃</button>'),_t=C('<button class="icon-button login-button svelte-gnpoyf">로그인</button>'),ht=C('<div class="error-banner svelte-gnpoyf"> </div>'),mt=C('<div class="messages-loading svelte-gnpoyf"><div class="spinner svelte-gnpoyf"></div></div>'),yt=C('<div class="empty-state svelte-gnpoyf">새로운 대화를 시작해보세요.</div>'),wt=C('<div class="date-sep svelte-gnpoyf"> </div>'),bt=C("<div><!></div>"),kt=C('<div class="chat-messages svelte-gnpoyf"><!> <!></div>'),xt=C('<div class="layout svelte-gnpoyf"><aside><button class="new-chat svelte-gnpoyf">New Chat</button> <!></aside> <div class="chat-page-container svelte-gnpoyf"><header class="chat-header svelte-gnpoyf"><div class="header-left svelte-gnpoyf"><button class="icon-button toggle-button svelte-gnpoyf" aria-label="Toggle sidebar"><!></button> <span class="header-title svelte-gnpoyf"> </span></div> <div class="header-right svelte-gnpoyf"><!></div></header> <!> <div class="chat-messages-wrapper svelte-gnpoyf"><!></div> <div class="chat-input-area svelte-gnpoyf"><div class="textarea-container svelte-gnpoyf"><input placeholder="메시지 입력" class="svelte-gnpoyf"></div> <button class="icon-button action-button svelte-gnpoyf" aria-label="Send"><!></button></div> <footer class="chat-footer svelte-gnpoyf">Velt는 실수를 할 수 있습니다. 중요한 정보는 재차 확인하세요.</footer></div></div>');function Ht(i,e){Xe(e,!1);let a=$([]),r=$(null),o=$([]),f=$(""),l=$(!1),_=$(),m=$(),u=$(!1),s=$(""),y=$(!1),v=$(!1),c=$([]),p=$("새로운 채팅"),w=$(!1);Ja(()=>{t(l)&&M()});async function b(){h(y,!0),h(s,"");try{const n=localStorage.getItem("authToken"),g=await fetch("/api/v1/chat/sessions",{headers:{Authorization:`Bearer ${n}`}});if(!g.ok)throw new Error("세션 목록을 가져오는데 실패했습니다.");h(a,await g.json())}catch(n){h(s,n.message)}finally{h(y,!1)}}async function d(n){h(v,!0),h(s,"");try{const g=localStorage.getItem("authToken"),E=await fetch(`/api/v1/chat/${n}/messages`,{headers:{Authorization:`Bearer ${g}`}});if(!E.ok)throw new Error("메시지 목록을 가져오는데 실패했습니다.");const H=await E.json();h(o,H.map(k=>({id:k.id,text:k.content,content:k.content,sender:k.sender==="human"?"user":"ai",timestamp:k.created_at})))}catch(g){h(s,g.message)}finally{h(v,!1)}await ee(),M()}async function I(n){h(l,!0),await ee(),M();const g=localStorage.getItem("authToken");let E="오류: AI 응답을 가져올 수 없습니다.";if(!g)return h(l,!1),await de("/login?redirectTo=/"),"";try{const H={user_message:n};t(r)&&(H.session_id=t(r));const k=await fetch("/api/v1/chat/",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g}`},body:JSON.stringify(H)});if(k.status===401)return localStorage.removeItem("authToken"),h(u,!1),await de("/login?sessionExpired=true"),"";if(!k.ok){let F={detail:"API 오류가 발생했습니다."};try{F=await k.json()}catch{}throw new Error(F.detail||`HTTP error! status: ${k.status}`)}const S=await k.json();if(S&&S.ai_response)!t(r)&&S.session_id&&(h(r,S.session_id),await b()),E=S.ai_response;else throw console.error("Unexpected API response format:",S),new Error("수신된 데이터 형식이 올바르지 않습니다.")}catch(H){console.error("Failed to get AI response:",H),h(s,H.message||"AI 응답 처리 중 오류 발생"),E=t(s)}finally{h(l,!1)}return E}async function M(){await ee(),t(m)&&(t(m).scrollTo({top:t(m).scrollHeight,behavior:"smooth"}),setTimeout(()=>{t(m).scrollTo({top:t(m).scrollHeight,behavior:"smooth"})},300))}async function L(){const n=t(f).trim();if(!n||t(l))return;h(o,[...t(o),{id:Date.now(),text:n,content:n,sender:"user",timestamp:new Date().toISOString()}]),await ee(),M(),h(f,""),await ee(),D();const g=await I(n);g&&(h(o,[...t(o),{id:Date.now()+1,text:g,content:g,sender:"ai",timestamp:new Date().toISOString()}]),await ee(),setTimeout(()=>{M()},100))}function D(){if(!t(_))return;const n=40,g=120;Oe(_,t(_).style.height="auto");const E=Math.max(n,Math.min(t(_).scrollHeight,g));Oe(_,t(_).style.height=`${E}px`)}async function q(){localStorage.removeItem("authToken"),h(u,!1),await de("/login")}async function U(n){const g=localStorage.getItem("authToken");try{if(!(await fetch(`/api/v1/chat/${n}`,{method:"DELETE",headers:{Authorization:`Bearer ${g}`}})).ok)throw new Error("세션 삭제에 실패했습니다.");h(a,t(a).filter(H=>H.id!==n)),t(r)===n&&(h(r,null),h(o,[]))}catch(E){h(s,E.message)}}Ya(async()=>{const n=localStorage.getItem("authToken");h(u,!!n),await b(),t(_)&&t(_).focus()}),Ae(()=>t(r),()=>{h(p,t(r)!=null?`Session ${t(r)}`:"새로운 채팅")}),Ae(()=>(t(c),t(o)),()=>{let n="";h(c,[]);for(const g of t(o)){const E=new Date(g.timestamp).toLocaleDateString();E!==n&&(t(c).push({type:"date",date:E}),n=E),t(c).push({type:"message",message:g})}}),Ze(),Ye();var z=xt(),R=x(z),ne=x(R),ta=N(ne,2);{var ra=n=>{var g=ut();A(n,g)},sa=n=>{var g=ke(),E=Ee(g);qe(E,1,()=>t(a),Pe,(H,k)=>{var S=gt(),F=x(S),j=x(F),ye=x(j,!0);T(j);var ce=N(j,2),G=x(ce,!0);T(ce),T(F);var K=N(F,2);T(S),P((Z,we)=>{pe(S,1,`session-item ${(t(k).id===t(r)?"selected":"")??""}`,"svelte-gnpoyf"),X(ye,Z),X(G,we)},[()=>t(k).first_user_message?t(k).first_user_message.length>20?t(k).first_user_message.slice(0,20)+"...":t(k).first_user_message:"새로운 대화",()=>t(k).first_ai_response?t(k).first_ai_response.length>20?t(k).first_ai_response.slice(0,20)+"...":t(k).first_ai_response:""],ie),W("click",K,Z=>{Z.stopPropagation(),U(t(k).id)}),W("click",S,()=>{h(r,t(k).id),d(t(k).id)}),A(H,S)}),A(n,g)};O(ta,n=>{t(y)?n(ra):n(sa,!1)})}T(R);var Ie=N(R,2),_e=x(Ie),he=x(_e),oe=x(he),ia=x(oe);dt(ia,{}),T(oe);var $e=N(oe,2),na=x($e,!0);T($e),T(he);var Ce=N(he,2),oa=x(Ce);{var la=n=>{var g=pt();W("click",g,q),A(n,g)},va=n=>{var g=_t();W("click",g,()=>de("/login")),A(n,g)};O(oa,n=>{t(u)?n(la):n(va,!1)})}T(Ce),T(_e);var Me=N(_e,2);{var fa=n=>{var g=ht(),E=x(g,!0);T(g),P(()=>X(E,t(s))),A(n,g)};O(Me,n=>{t(s)&&n(fa)})}var le=N(Me,2),ca=x(le);{var da=n=>{var g=mt();A(n,g)},ua=n=>{var g=ke(),E=Ee(g);{var H=S=>{var F=yt();A(S,F)},k=S=>{var F=kt(),j=x(F);qe(j,1,()=>t(c),Pe,(G,K)=>{var Z=ke(),we=Ee(Z);{var pa=Q=>{var V=wt(),be=x(V,!0);T(V),P(()=>X(be,t(K).date)),A(Q,V)},_a=Q=>{var V=bt(),be=x(V);We(be,{get message(){return t(K).message}}),T(V),tt(3,V,()=>lt,()=>({duration:300})),A(Q,V)};O(we,Q=>{t(K).type==="date"?Q(pa):Q(_a,!1)})}A(G,Z)});var ye=N(j,2);{var ce=G=>{const K=ie(()=>({id:-1,text:"...",sender:"ai",timestamp:new Date().toISOString()}));We(G,{get message(){return t(K)},isLoading:!0})};O(ye,G=>{t(l)&&G(ce)})}T(F),A(S,F)};O(E,S=>{t(c).length===0?S(H):S(k,!1)})}A(n,g)};O(ca,n=>{t(v)?n(da):n(ua,!1)})}T(le),Be(le,n=>h(m,n),()=>t(m));var De=N(le,2),me=x(De),ve=x(me);Wa(ve),Be(ve,n=>h(_,n),()=>t(_)),T(me);var fe=N(me,2),ga=x(fe);ft(ga,{}),T(fe),T(De),Pa(2),T(Ie),T(z),P(n=>{pe(R,1,`sidebar ${(t(w)?"collapsed":"")??""}`,"svelte-gnpoyf"),X(na,t(p)),fe.disabled=n},[()=>!t(f).trim()||t(l)],ie),W("click",ne,()=>{h(r,null),h(o,[])}),W("click",oe,()=>h(w,!t(w))),Va(ve,()=>t(f),n=>h(f,n)),W("keydown",ve,n=>{n.key==="Enter"&&(n.preventDefault(),L())}),W("click",fe,L),A(i,z),Qe()}export{Ht as component};
